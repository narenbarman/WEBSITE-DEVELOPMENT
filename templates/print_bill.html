<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Bill - {{ bill.id[:8].upper() }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        @media print {
            body {
                font-size: 12px;
                line-height: 1.4;
            }
            .no-print {
                display: none !important;
            }
            .bill-container {
                box-shadow: none;
                border: 1px solid #000;
            }
            .bill-header {
                border-bottom: 2px solid #000;
            }
        }

        .bill-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .bill-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .bill-header h1 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 28px;
        }

        .bill-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-section h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .info-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        .bill-items {
            margin-bottom: 30px;
        }

        .bill-items h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .items-table th,
        .items-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .items-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            border-bottom: 2px solid #333;
        }

        .items-table .text-right {
            text-align: right;
        }

        .bill-totals {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 30px;
        }

        .totals-table {
            width: 300px;
            border-collapse: collapse;
        }

        .totals-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
        }

        .totals-table .total-row {
            border-top: 2px solid #333;
            font-weight: bold;
            font-size: 16px;
        }

        .bill-footer {
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 20px;
            font-size: 12px;
            color: #666;
        }

        .print-actions {
            text-align: center;
            margin-bottom: 20px;
        }

        .print-actions button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }

        .print-actions button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="print-actions no-print">
        <button onclick="window.print()">üñ®Ô∏è Print Bill</button>
        <button onclick="generateWhatsAppMessage()">üì± WhatsApp Message</button>
        <button onclick="window.close()">‚úï Close</button>
    </div>

    <div class="bill-container">
        <div class="bill-header">
            <h1>Barman Store</h1>
            <p>Invoice/Bill</p>
            <p><strong>Bill ID:</strong> {{ bill.id[:8].upper() }}</p>
            <p><strong>Date:</strong> {{ bill.date }}</p>
        </div>

        <div class="bill-info">
            <div class="info-section">
                <h3>Bill To:</h3>
                <p><strong>Name:</strong> {{ bill.user_name }}</p>
                <p><strong>Email:</strong> {{ bill.user_email }}</p>
                <p><strong>Phone:</strong> {{ bill.user_phone }}</p>
                {% if bill.user_address %}
                <p><strong>Address:</strong> {{ bill.user_address }}</p>
                {% endif %}
            </div>

            <div class="info-section">
                <h3>Bill Details:</h3>
                <p><strong>Status:</strong> {{ bill.status.title() }}</p>
                <p><strong>Order Date:</strong> {{ bill.date }}</p>
                <p><strong>Bill Generated:</strong> {{ bill.date }}</p>
            </div>
        </div>

        <div class="bill-items">
            <h3>Items:</h3>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Product/Service</th>
                        <th>Description</th>
                        <th style="text-align: center;">Qty</th>
                        <th style="text-align: right;">Rate</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in bill.get('items', []) %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.description or '-' }}</td>
                        <td style="text-align: center;">{{ item.quantity }}</td>
                        <td style="text-align: right;">‚Çπ{{ "%.2f"|format(item.price) }}</td>
                        <td style="text-align: right;">‚Çπ{{ "%.2f"|format(item.subtotal) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bill-totals">
            <table class="totals-table">
                <tr>
                    <td><strong>Subtotal:</strong></td>
                    <td style="text-align: right;">‚Çπ{{ "%.2f"|format(bill.total_amount) }}</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Grand Total:</strong></td>
                    <td style="text-align: right;">‚Çπ{{ "%.2f"|format(bill.total_amount) }}</td>
                </tr>
            </table>
        </div>

        <div class="bill-footer">
            <p>Thank you for your business!</p>
            <p>Barman Store - Quality products at affordable prices</p>
            <p>For any queries, please contact us at support@barmanstore.com</p>
        </div>
    </div>

    <script>
        function generateWhatsAppMessage() {
            const billData = {
                id: "{{ bill.id }}",
                date: "{{ bill.date }}",
                user_name: "{{ bill.user_name }}",
                user_phone: "{{ bill.user_phone or '' }}",
                user_email: "{{ bill.user_email or '' }}",
                user_address: "{{ bill.user_address or '' }}",
                total_amount: {{ bill.total_amount }},
                items: [
                    {% for item in bill.get('items', []) %}
                    {
                        name: "{{ item.name }}",
                        description: "{{ item.description or '' }}",
                        quantity: {{ item.quantity }},
                        price: {{ item.price }},
                        subtotal: {{ item.subtotal }}
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            };

            let message = `*Barman Store - Invoice*\n\n`;
            message += `*Bill ID:* ${billData.id.substring(0, 8).toUpperCase()}\n`;
            message += `*Date:* ${billData.date}\n\n`;

            message += `*Customer Details:*\n`;
            message += `Name: ${billData.user_name}\n`;
            if (billData.user_phone) message += `Phone: ${billData.user_phone}\n`;
            if (billData.user_email) message += `Email: ${billData.user_email}\n`;
            if (billData.user_address) message += `Address: ${billData.user_address}\n\n`;

            message += `*Items:*\n`;
            billData.items.forEach((item, index) => {
                message += `${index + 1}. ${item.name}\n`;
                if (item.description) message += `   ${item.description}\n`;
                message += `   Qty: ${item.quantity} √ó ‚Çπ${parseFloat(item.price).toFixed(2)} = ‚Çπ${parseFloat(item.subtotal).toFixed(2)}\n\n`;
            });

            message += `*Total Amount: ‚Çπ${parseFloat(billData.total_amount).toFixed(2)}*\n\n`;

            message += `Thank you for shopping with Barman Store! üõí\n`;
            message += `For any queries, contact us at support@barmanstore.com`;

            // Create a modal to display the message
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;

            modalContent.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">üì± WhatsApp Message</h3>
                <p>Copy the message below and paste it in WhatsApp:</p>
                <textarea id="whatsapp-message" style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical;" readonly>${message}</textarea>
                <div style="text-align: right; margin-top: 15px;">
                    <button onclick="copyToClipboard(document.getElementById('whatsapp-message'))" style="background: #25d366; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">üìã Copy Message</button>
                    <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function copyToClipboard(textarea) {
            // Simple and reliable approach
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    // Fallback: create a temporary input
                    const tempInput = document.createElement('input');
                    tempInput.value = textarea.value;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    const inputSuccess = document.execCommand('copy');
                    document.body.removeChild(tempInput);

                    if (inputSuccess) {
                        showCopySuccess();
                    } else {
                        manualCopyInstructions();
                    }
                }
            } catch (err) {
                console.log('Copy failed:', err);
                manualCopyInstructions();
            }
        }

        function manualCopyInstructions() {
            alert('Copy failed. Please manually select all text (Ctrl+A) and copy (Ctrl+C).');
        }

        function showCopySuccess() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Copied!';
            button.style.background = '#28a745';

            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#25d366';
            }, 2000);
        }

        // Auto-print when page loads (optional)
        // window.onload = function() {
        //     window.print();
        // };
    </script>
</body>
</html>